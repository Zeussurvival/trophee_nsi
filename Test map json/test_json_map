import os
import pygame
import json

# Initialisation de Pygame
pygame.init()

# Chargement des données de la carte
try:
    script_dir = os.path.dirname(__file__)  # Répertoire du script
    map_path = os.path.join(script_dir, "map.json")
    with open(map_path) as f:
        map_data = json.load(f)
except FileNotFoundError:
    print("Erreur : Le fichier map.json est introuvable.")
    exit()
except json.JSONDecodeError:
    print("Erreur : Le fichier map.json contient des erreurs.")
    exit()

# Taille des tuiles et dimensions de la carte
TILE_SIZE = map_data.get("tileSize", 32)
MAP_WIDTH = map_data.get("mapWidth", 10)  # Largeur de la carte en tuiles
MAP_HEIGHT = map_data.get("mapHeight", 10)  # Hauteur de la carte en tuiles

print("Taille des tuiles :", TILE_SIZE)
print("Largeur de la carte :", MAP_WIDTH)
print("Hauteur de la carte :", MAP_HEIGHT)

# Initialisation de la fenêtre Pygame en fonction des dimensions de la carte
screen = pygame.display.set_mode((MAP_WIDTH * TILE_SIZE, MAP_HEIGHT * TILE_SIZE))
clock = pygame.time.Clock()

# Chargement du tileset
try:
    tileset_path = os.path.join(script_dir, "spritesheet.png")
    tileset = pygame.image.load(tileset_path).convert_alpha()
except FileNotFoundError:
    print("Erreur : Le fichier spritesheet.png est introuvable.")
    exit()

# Découpage des tuiles
tiles = []
for y in range(0, tileset.get_height(), TILE_SIZE):
    for x in range(0, tileset.get_width(), TILE_SIZE):
        tiles.append(tileset.subsurface(pygame.Rect(x, y, TILE_SIZE, TILE_SIZE)))

print("Nombre de tuiles découpées :", len(tiles))

# Boucle principale
running = True
while running:
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False

    # Remplir l'écran avec une couleur de fond
    screen.fill((0, 0, 0))

    # Dessiner les couches de la carte
    for layer in map_data.get("layers", []):
        for tile in layer.get("tiles", []):
            tile_id = int(tile["id"])  # Convertir l'ID en entier
            x = int(tile["x"]) * TILE_SIZE  # Position en pixels
            y = int(tile["y"]) * TILE_SIZE  # Position en pixels
            if 0 <= tile_id < len(tiles):  # Vérifier que l'ID est valide
                screen.blit(tiles[tile_id], (x, y))
            else:
                print(f"ID de tuile invalide : {tile_id}")

    # Rafraîchir l'écran
    pygame.display.flip()
    clock.tick(60)

pygame.quit()